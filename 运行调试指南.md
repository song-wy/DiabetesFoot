# 运行调试指南

## 前置条件

1. **Visual Studio 2019/2022**（已安装）
2. **SQL Server LocalDB**（通常随 Visual Studio 一起安装）
3. **.NET Framework 4.7.2**（或更高版本）

## 运行步骤

### 方法1：在 Visual Studio 中运行（推荐）

1. **打开项目**
   - 打开 Visual Studio
   - 文件 → 打开 → 项目/解决方案
   - 选择 `DiabetesFoot.sln` 文件

2. **还原 NuGet 包**
   - 右键点击解决方案
   - 选择"还原 NuGet 包"
   - 等待包还原完成

3. **检查数据库连接**
   - 确保 SQL Server LocalDB 正在运行
   - 打开 SQL Server 对象资源管理器（视图 → SQL Server 对象资源管理器）
   - 检查是否能连接到 `(localdb)\MSSQLLocalDB`

4. **运行项目**
   - 按 `F5` 或点击"启动"按钮
   - 或者选择"调试" → "开始调试"
   - 浏览器会自动打开项目

5. **首次运行**
   - 首次运行时会自动创建数据库
   - 如果出现数据库错误，请参考下面的"数据库迁移"部分

### 方法2：使用 IIS Express 运行

1. **在 Visual Studio 中**
   - 选择项目
   - 在属性窗口中设置启动项目
   - 点击"启动"按钮

2. **使用命令行**
   ```powershell
   # 导航到项目目录
   cd DiabetesFoot
   
   # 使用 IIS Express 运行（需要 Visual Studio 开发者命令提示符）
   "C:\Program Files\IIS Express\iisexpress.exe" /path:"D:\ASP.NET实训\DiabetesFoot\DiabetesFoot" /port:8080
   ```

## 数据库迁移

### 方法1：删除现有数据库（开发环境，简单快速）

1. **停止 IIS Express 和应用程序**
2. **删除数据库文件**
   - 删除 `DiabetesFoot/App_Data` 文件夹中的所有 `.mdf` 和 `.ldf` 文件
   - 包括：
     - `aspnet-DiabetesFoot-*.mdf`
     - `DefaultConnection.mdf`
     - `DiabetesFootManagement.mdf`
     - 以及对应的 `.ldf` 文件
3. **重新运行项目**
   - 项目会自动创建新的数据库
   - Entity Framework 会自动创建所有表结构

### 方法2：使用 Code First Migrations（推荐用于生产环境）

1. **打开包管理器控制台**
   - 工具 → NuGet 包管理器 → 包管理器控制台

2. **启用迁移**
   ```powershell
   Enable-Migrations
   ```

3. **创建迁移**
   ```powershell
   # 为 Identity 数据库创建迁移
   Add-Migration InitialCreate -ContextTypeName DiabetesFoot.Models.ApplicationDbContext
   
   # 为业务数据库创建迁移
   Add-Migration InitialCreate -ContextTypeName DiabetesFoot.Models.DiabetesFootDbContext
   ```

4. **更新数据库**
   ```powershell
   # 更新 Identity 数据库
   Update-Database -ContextTypeName DiabetesFoot.Models.ApplicationDbContext
   
   # 更新业务数据库
   Update-Database -ContextTypeName DiabetesFoot.Models.DiabetesFootDbContext
   ```

## 常见问题

### 1. 数据库连接错误

**问题**：无法连接到数据库

**解决方法**：
- 检查 SQL Server LocalDB 是否正在运行
- 打开 SQL Server 配置管理器
- 启动 SQL Server (MSSQLLocalDB)
- 或者在 Visual Studio 中打开 SQL Server 对象资源管理器，尝试连接

### 2. 编译错误

**问题**：项目无法编译

**解决方法**：
- 检查是否所有 NuGet 包都已还原
- 右键点击解决方案 → 还原 NuGet 包
- 清理解决方案：生成 → 清理解决方案
- 重新生成：生成 → 重新生成解决方案

### 3. 数据库表不存在

**问题**：运行时出现"表不存在"错误

**解决方法**：
- 删除 `App_Data` 文件夹中的数据库文件
- 重新运行项目，让 Entity Framework 自动创建数据库
- 或者使用 Code First Migrations（见上面的"数据库迁移"部分）

### 4. 身份验证错误

**问题**：无法登录或注册

**解决方法**：
- 检查 `Web.config` 中的连接字符串是否正确
- 确保 `DefaultConnection` 连接字符串存在
- 检查 Identity 数据库是否正确创建

### 5. 端口被占用

**问题**：IIS Express 无法启动，端口被占用

**解决方法**：
- 更改项目属性中的端口号
- 或者在 `Properties/launchSettings.json` 中修改端口
- 或者关闭占用端口的其他应用程序

## 测试账户

首次运行项目后，需要注册账户：

1. **注册新账户**
   - 访问 `/Account/Register`
   - 填写注册信息
   - 密码要求：
     - 至少 6 个字符
     - 至少包含一个数字
     - 至少包含一个小写字母
     - 至少包含一个大写字母
     - 至少包含一个非字母数字字符

2. **登录**
   - 访问 `/Account/Login`
   - 使用注册的账户登录

## 功能测试清单

运行项目后，建议测试以下功能：

### 患者管理
- [ ] 添加新患者
- [ ] 查看患者列表
- [ ] 查看患者详情
- [ ] 编辑患者信息
- [ ] 删除患者

### 血糖记录
- [ ] 添加血糖记录
- [ ] 查看血糖记录列表
- [ ] 查看全部血糖记录
- [ ] 测试危急值检测

### 伤口记录
- [ ] 添加伤口记录
- [ ] 上传伤口照片
- [ ] 查看伤口记录列表
- [ ] 编辑伤口记录
- [ ] 删除伤口记录
- [ ] 查看愈合进度图表

### 药物管理
- [ ] 添加药物记录
- [ ] 查看药物列表
- [ ] 编辑药物记录
- [ ] 删除药物记录
- [ ] 查看药物提醒

## 调试技巧

### 1. 使用断点
- 在代码中设置断点（F9）
- 运行调试（F5）
- 程序会在断点处暂停
- 可以查看变量值、调用堆栈等

### 2. 查看输出窗口
- 视图 → 输出
- 选择"调试"或"生成"
- 查看编译和运行时信息

### 3. 使用浏览器开发者工具
- 按 F12 打开浏览器开发者工具
- 查看控制台错误
- 查看网络请求
- 查看元素样式

### 4. 查看日志
- 检查 `App_Data` 文件夹中的日志文件
- 查看 Windows 事件查看器
- 在代码中添加日志记录

## 性能优化建议

1. **启用编译优化**
   - 发布配置使用 Release 模式
   - 禁用调试符号

2. **数据库优化**
   - 添加索引
   - 优化查询
   - 使用缓存

3. **前端优化**
   - 压缩 JavaScript 和 CSS
   - 使用 CDN
   - 优化图片大小

## 下一步

项目运行成功后，可以：
1. 测试所有功能
2. 添加更多功能
3. 优化性能和用户体验
4. 部署到服务器

---

**最后更新**：2025年1月
**项目版本**：1.0.0

